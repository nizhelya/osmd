/*
 * File: app/view/flat/TabOrg.js
 * Date: Fri Sep 18 2020 11:43:03 GMT+0300 (EEST)
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Osmd.view.flat.TabOrg', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.taborg',

    requires: [
        'Osmd.view.flat.TabOrgViewModel',
        'Ext.form.Panel',
        'Ext.form.field.ComboBox',
        'Ext.form.field.Number',
        'Ext.form.FieldSet',
        'Ext.form.field.TextArea',
        'Ext.button.Button'
    ],

    viewModel: {
        type: 'taborg'
    },
    height: 740,
    id: 'tabOrg',
    scrollable: true,
    width: 940,
    layout: 'fit',
    title: 'Организация',
    defaultListenerScope: true,

    items: [
        {
            xtype: 'form',
            id: 'fmOrg',
            scrollable: true,
            layout: 'absolute',
            title: '',
            paramsAsHash: true,
            items: [
                {
                    xtype: 'combobox',
                    x: 20,
                    y: 20,
                    width: 335,
                    fieldLabel: 'ОСББ',
                    labelWidth: 50,
                    name: 'osmd_id',
                    displayField: 'osmd',
                    queryMode: 'local',
                    store: 'StOsmd',
                    valueField: 'osmd_id',
                    listeners: {
                        select: 'onComboboxSelect2111'
                    }
                },
                {
                    xtype: 'numberfield',
                    x: 370,
                    y: 20,
                    width: 110,
                    fieldLabel: 'Ид',
                    labelWidth: 30,
                    name: 'org_id',
                    hideTrigger: true,
                    allowDecimals: false,
                    decimalPrecision: 0
                },
                {
                    xtype: 'fieldset',
                    x: 25,
                    y: 105,
                    height: 125,
                    style: 'background-color: #DCDCDC;',
                    width: 895,
                    layout: 'absolute',
                    title: 'Найменування, реквізити',
                    items: [
                        {
                            xtype: 'textareafield',
                            x: 5,
                            y: 40,
                            width: 555,
                            fieldLabel: 'Повний',
                            name: 'fname',
                            allowBlank: false,
                            grow: true
                        },
                        {
                            xtype: 'textareafield',
                            x: 565,
                            y: 40,
                            width: 300,
                            fieldLabel: 'Телефони',
                            labelWidth: 80,
                            name: 'phone',
                            grow: true
                        },
                        {
                            xtype: 'textfield',
                            x: 5,
                            y: 10,
                            formBind: false,
                            width: 650,
                            fieldLabel: 'Cкорочена',
                            name: 'osmd',
                            allowBlank: false,
                            maxLength: 70
                        },
                        {
                            xtype: 'textfield',
                            x: 670,
                            y: 10,
                            width: 195,
                            fieldLabel: 'ЕДРПОУ',
                            labelWidth: 60,
                            name: 'edrpou',
                            allowBlank: false,
                            maxLength: 12
                        }
                    ]
                },
                {
                    xtype: 'fieldset',
                    x: 25,
                    y: 235,
                    height: 160,
                    padding: '10 10 10 10',
                    style: 'background-color: #DCDCDC;',
                    width: 895,
                    title: 'Адреса',
                    items: [
                        {
                            xtype: 'textareafield',
                            height: 50,
                            width: 866,
                            fieldLabel: 'Юридичний',
                            name: 'uaddress',
                            enableKeyEvents: true,
                            grow: true,
                            listeners: {
                                change: 'onTextareafieldChange2'
                            }
                        },
                        {
                            xtype: 'textareafield',
                            id: 'faddress',
                            width: 867,
                            fieldLabel: 'Фізичний',
                            name: 'faddress'
                        }
                    ]
                },
                {
                    xtype: 'fieldset',
                    x: 25,
                    y: 490,
                    height: 200,
                    padding: '10 10 10 10',
                    style: 'background-color: #DCDCDC;',
                    width: 890,
                    layout: 'absolute',
                    title: 'Банківські реквізити',
                    items: [
                        {
                            xtype: 'textfield',
                            x: 5,
                            y: 0,
                            formBind: false,
                            width: 860,
                            fieldLabel: 'Банк',
                            name: 'bank'
                        },
                        {
                            xtype: 'textfield',
                            x: 5,
                            y: 30,
                            formBind: false,
                            width: 193,
                            fieldLabel: 'МФО',
                            name: 'mfo'
                        },
                        {
                            xtype: 'textfield',
                            x: 205,
                            y: 30,
                            formBind: false,
                            width: 335,
                            fieldLabel: 'Розрахунковий рахунок',
                            labelWidth: 140,
                            name: 'account'
                        },
                        {
                            xtype: 'textfield',
                            x: 205,
                            y: 60,
                            formBind: false,
                            width: 335,
                            fieldLabel: 'Додатковий рахунок',
                            labelWidth: 140,
                            name: 'daccount'
                        },
                        {
                            xtype: 'textfield',
                            x: 550,
                            y: 30,
                            formBind: false,
                            width: 115,
                            fieldLabel: 'ipay',
                            labelWidth: 40,
                            name: 'ipay'
                        },
                        {
                            xtype: 'textfield',
                            x: 670,
                            y: 30,
                            formBind: false,
                            width: 195,
                            fieldLabel: 'приват банк',
                            name: 'pb'
                        },
                        {
                            xtype: 'textareafield',
                            x: 5,
                            y: 95,
                            width: 860,
                            fieldLabel: 'Пункти оплати',
                            name: 'kassa'
                        }
                    ]
                },
                {
                    xtype: 'fieldset',
                    x: 25,
                    y: 400,
                    height: 85,
                    style: 'background-color: #DCDCDC;',
                    width: 890,
                    layout: 'absolute',
                    title: 'Керівництво',
                    items: [
                        {
                            xtype: 'textfield',
                            x: 365,
                            y: 0,
                            width: 495,
                            fieldLabel: 'Посада',
                            name: 'vosobi',
                            maxLength: 50
                        },
                        {
                            xtype: 'textfield',
                            x: 0,
                            y: 30,
                            width: 325,
                            fieldLabel: 'Гол.Бухгалтер',
                            name: 'gbuh'
                        },
                        {
                            xtype: 'textfield',
                            x: 365,
                            y: 30,
                            width: 325,
                            fieldLabel: 'Бухгалтер',
                            name: 'buh'
                        },
                        {
                            xtype: 'textfield',
                            x: 0,
                            y: 0,
                            width: 325,
                            fieldLabel: 'Керівник',
                            name: 'boss'
                        }
                    ]
                },
                {
                    xtype: 'button',
                    handler: function(button, e) {
                        // in use
                        //STORE
                        var me = this;
                        var stUser = Ext.data.StoreManager.get("StUser");
                        var values =stUser.getAt(0);
                        var value = button.findParentByType('form').getValues();
                        var form = button.findParentByType('form').getForm();
                        var osmd_id = form.findField('osmd_id').getValue();
                        var StOrg = Ext.data.StoreManager.get("StOrg");


                        //LOGIN & PASSWORD
                        var params = {
                            login:values.get('login'),
                            password:values.get('password'),
                            osmd_id:osmd_id,
                            what:"editOsmd"

                        };

                        //LOGIKA

                        Ext.Object.merge(value, params);

                        QueryAddress.updateRecords(value,function(results){
                            if(results.success==="1"){
                                Ext.MessageBox.show({
                                    title: 'Редактирование записи  ',
                                    msg: results.msg,
                                    buttons: Ext.MessageBox.OK,
                                    icon: Ext.MessageBox.INFO
                                });
                                StOrg.load({
                                    params: {
                                        what:"osmd",
                                        osmd_id:osmd_id,
                                        login:values.get('login'),
                                        password:values.get('password')
                                    },
                                    scope:this
                                });
                            } else {
                                Ext.MessageBox.show({
                                    title: 'Редактирование записи ',
                                    msg: results.msg,
                                    buttons: Ext.MessageBox.OK,
                                    icon: Ext.MessageBox.ERROR
                                });
                            }

                        });

                    },
                    x: 645,
                    y: 20,
                    formBind: true,
                    id: 'btnUpdateOrg',
                    width: 265,
                    icon: 'resources/css/images/ico/edit.png',
                    text: 'Оновити дані по ОСББ'
                },
                {
                    xtype: 'button',
                    handler: function(button, e) {
                        var me = this;
                        var stUser = Ext.data.StoreManager.get("StUser");
                        var values =stUser.getAt(0);
                        var value = button.findParentByType('form').getValues();
                        var form = button.findParentByType('form').getForm();
                        var osmd_id = form.findField('osmd_id').getValue();


                        //LOGIN & PASSWORD
                        var params = {
                            login:values.get('login'),
                            password:values.get('password'),
                            osmd_id:osmd_id,
                            what:"EmailInfoApp"

                        };
                        var myMask= Ext.Msg.show({
                            title: 'Отправка информационного листка',
                            msg: 'Отправка информационного листка .Ожидайте...',
                            buttons: Ext.Msg.CANCEL,
                            wait: true,
                            modal: true,
                            icon: Ext.Msg.INFO
                        });
                        QueryAddress.updateRecords(params,function(results){
                            if(results.success==="1"){
                                setTimeout(function(){
                                    QueryExportInfoApp.exportToEmail(params,function(results){
                                        if(results.success){
                                            myMask.close();
                                            Ext.MessageBox.show({
                                                title: 'Отправка информационного листка',
                                                msg: results.msg,
                                                buttons: Ext.MessageBox.OK,
                                                icon: Ext.MessageBox.INFO
                                            });

                                        } else {
                                            myMask.close();

                                            Ext.MessageBox.show({
                                                title: 'Отправка информационного листка',
                                                msg: results.msg,
                                                buttons: Ext.MessageBox.OK,
                                                icon: Ext.MessageBox.ERROR
                                            });
                                        }
                                    }, 250);
                                });
                            }



                        });
                    },
                    x: 550,
                    y: 65,
                    formBind: true,
                    id: 'btnEmailInfoApp',
                    width: 360,
                    icon: 'resources/css/images/news/article.gif',
                    text: 'Розсилка інформаційного листка по Email'
                },
                {
                    xtype: 'button',
                    handler: function(button, e) {
                        //in use
                        var me = this;
                        var StUser = Ext.data.StoreManager.get("StUser");
                        var values =StUser.getAt(0);
                        var tabPnCenter =  Ext.getCmp('tabPnCenter');//me.getTabPnCenter();

                        var report = 'InfoOsmd';
                        var namereport = 'Инфо ОСМД';
                        var value = {
                            login:values.get('login'),
                            password:values.get('password'),
                            osmd_id:values.get('osmd_id'),
                            report:report,
                            what:report

                        };
                        var tab = tabPnCenter.child('#'+report);
                        if (!tab) {
                            tab  = tabPnCenter.add({
                                xtype:'tabreportorg',
                                title:namereport,
                                id:''+report+''
                            });

                        }
                        //console.log(value);

                        tabPnCenter.setActiveTab(tab);
                        var reppan = tab.getComponent(0);
                        // Basic mask:
                        var myMask= Ext.Msg.show({
                            title:'Загрузка...',
                            msg: 'Загрузка отчета .Ожидайте...',
                            buttons: Ext.Msg.CANCEL,
                            wait: true,
                            modal: true,
                            icon: Ext.Msg.INFO
                        });
                        QueryReport.getResults(value,function(data){
                            if (data){
                                reppan.update(data.content);
                                Ext.REPORTCONTENT =data.content;
                                Ext.REPORTSQL =data.sql;
                                Ext.REPORTTITLE =report;
                                myMask.close();

                            } else {
                                myMask.close();
                                Ext.MessageBox.show({
                                    title: 'Ошибка ',
                                    msg: 'Документ не создан',
                                    buttons: Ext.MessageBox.OK,
                                    icon: Ext.MessageBox.ERROR
                                });
                            }
                        });


                    },
                    x: 25,
                    y: 65,
                    id: 'btnInfoOsmd',
                    width: 295,
                    icon: 'resources/css/images/ico/printer.png',
                    text: 'Роздруківка інформації з усіх ОСББ'
                }
            ]
        }
    ],

    onComboboxSelect2111: function(combo, record, eOpts) {
        //STORE
        var stUser = Ext.data.StoreManager.get("StUser");
        var values =stUser.getAt(0);
        var login = values.get('login');
        var password = values.get('password');
        var btnUpdateOrg =  Ext.getCmp('btnUpdateOrg');
        var btnEmailInfoApp =  Ext.getCmp('btnEmailInfoApp');
        var btnInfoOsmd =  Ext.getCmp('btnInfoOsmd');

        var form =  Ext.getCmp('fmOrg');
        var Store = Ext.data.StoreManager.get("StOrg");


        //LOGIN & PASSWORD


        //LOGIKA
        if (record) {
            values.set({'osmd_id':record.get('osmd_id')});
            stUser.sync();
            Store.load({
                params: {
                    what:'osmd',
                    login:login,
                    password:password,
                    osmd_id: record.get('osmd_id')
                 },
                    callback: function(records,operation,success){

                        if(success){

                            if (records.length) {
                                form.getForm().loadRecord(records[0]);

                    }
                }
            },
            scope:this
        });

            btnUpdateOrg.setDisabled(false);
            btnEmailInfoApp.setDisabled(false);
            btnInfoOsmd.setDisabled(false);


        }
    },

    onTextareafieldChange2: function(field, newValue, oldValue, eOpts) {
        var me =this;

        var faddress = Ext.getCmp('faddress');
        //console.log(faddress);
        if (newValue) {
            faddress.setValue(newValue);
        }

    }

});